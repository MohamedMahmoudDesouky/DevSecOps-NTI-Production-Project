parameters:
  - name: imageName
    type: string
  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"
  - name: ecrRegistry
    type: string
    default: "$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com"
  - name: signingMethod
    type: string
    default: "keyless" # 'keyless' or 'keypair'
  - name: cosignKey
    type: string
    default: "" # Only needed for keypair method
  - name: rekorUrl
    type: string
    default: "https://rekor.sigstore.dev"
  # NEW (optional): keep issuer configurable
  - name: oidcIssuer
    type: string
    default: "https://vstoken.dev.azure.com/selcon"

steps:
  # 0) Prereqs on CentOS (wget + docker + aws)
  - script: |
      set -euo pipefail

      echo "== OS info =="
      cat /etc/os-release || true

      echo "== Install prerequisites (wget/curl) =="
      sudo dnf -y install wget curl

      echo "== Check docker =="
      if ! command -v docker >/dev/null 2>&1; then
        echo "Docker not found. Installing..."
        sudo dnf -y install dnf-plugins-core
        sudo dnf config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo
        sudo dnf -y install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
      fi
      sudo systemctl enable --now docker
      docker version
      docker info

      echo "== Check aws cli =="
      if ! command -v aws >/dev/null 2>&1; then
        sudo dnf -y install awscli
      fi
      aws --version
    displayName: "Prereqs (CentOS 10): docker + aws + wget/curl"

  # 1) Install cosign
  - script: |
      set -euo pipefail

      echo "##[section]Installing Cosign"

      if ! command -v cosign &> /dev/null; then
        COSIGN_VERSION="v2.2.2"
        wget -q "https://github.com/sigstore/cosign/releases/download/${COSIGN_VERSION}/cosign-linux-amd64"
        sudo install -m 0755 cosign-linux-amd64 /usr/local/bin/cosign
        rm -f cosign-linux-amd64
      fi

      cosign version
    displayName: "Install Cosign"

  # 2) Login to ECR (CentOS reliable)
  - script: |
      set -euo pipefail

      : "${AWS_REGION:?AWS_REGION is required}"
      : "${AWS_ACCOUNT_ID:?AWS_ACCOUNT_ID is required}"

      REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
      echo "Logging in to ECR: $REGISTRY"

      aws ecr get-login-password --region "${AWS_REGION}" \
        | docker login --username AWS --password-stdin "${REGISTRY}"

      echo "ECR login OK"
    displayName: "Login to ECR (aws ecr get-login-password)"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)
      AWS_ACCOUNT_ID: $(AWS_ACCOUNT_ID)

  # 3) Sign
  - script: |
      set -euo pipefail

      IMAGE_URI="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}:${{ parameters.imageTag }}"
      ISSUER="${{ parameters.oidcIssuer }}"

      echo "##[section]Signing image: $IMAGE_URI"
      echo "Signing method: ${{ parameters.signingMethod }}"
      echo "OIDC issuer: $ISSUER"

      if [ "${{ parameters.signingMethod }}" = "keyless" ]; then
        export COSIGN_EXPERIMENTAL=1

        cosign sign \
          --yes \
          --oidc-issuer "$ISSUER" \
          --rekor-url "${{ parameters.rekorUrl }}" \
          "$IMAGE_URI"

        echo "##[section]Image signed successfully with keyless method"

      elif [ "${{ parameters.signingMethod }}" = "keypair" ]; then
        if [ -z "${{ parameters.cosignKey }}" ]; then
          echo "##vso[task.logissue type=error]Cosign key not provided for keypair method"
          exit 1
        fi

        echo "${{ parameters.cosignKey }}" > /tmp/cosign.key
        COSIGN_PASSWORD="" cosign sign \
          --yes \
          --key /tmp/cosign.key \
          --rekor-url "${{ parameters.rekorUrl }}" \
          "$IMAGE_URI"
        rm -f /tmp/cosign.key

        echo "##[section]Image signed successfully with keypair method"
      else
        echo "##vso[task.logissue type=error]Invalid signing method: ${{ parameters.signingMethod }}"
        exit 1
      fi
    displayName: "Sign Image with Cosign"
    env:
      COSIGN_EXPERIMENTAL: 1
      SYSTEM_ACCESSTOKEN: $(System.AccessToken)

  # 4) Verify (FIXED issuer)
  - script: |
      set -euo pipefail

      IMAGE_URI="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}:${{ parameters.imageTag }}"
      ISSUER="${{ parameters.oidcIssuer }}"

      echo "##[section]Verifying signature"
      echo "OIDC issuer: $ISSUER"

      if [ "${{ parameters.signingMethod }}" = "keyless" ]; then
        export COSIGN_EXPERIMENTAL=1

        cosign verify \
          --certificate-oidc-issuer "$ISSUER" \
          --rekor-url "${{ parameters.rekorUrl }}" \
          "$IMAGE_URI"

      elif [ "${{ parameters.signingMethod }}" = "keypair" ]; then
        echo "Keypair verification requires public key (not implemented in this template)."
      fi

      echo "##[section]Signature verified successfully"
    displayName: "Verify Signature"
    env:
      COSIGN_EXPERIMENTAL: 1
    condition: succeeded()

  # 5) Tree
  - script: |
      set -euo pipefail
      IMAGE_URI="${{ parameters.ecrRegistry }}/${{ parameters.imageName }}:${{ parameters.imageTag }}"
      cosign tree "$IMAGE_URI" || true
    displayName: "Display Signature Tree"
    condition: succeeded()
