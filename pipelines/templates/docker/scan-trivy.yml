parameters:
  - name: imageName
    type: string
  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  - name: severityThreshold
    type: string
    default: "CRITICAL,HIGH,MEDIUM,LOW"

  - name: failOnVulnerabilities
    type: boolean
    default: true

  - name: ignoreUnfixed
    type: boolean
    default: false

  - name: trivyVersion
    type: string
    default: "latest"

  # Folder which contains rego policies + lib/
  - name: regoPolicyPath
    type: string
    default: "policies/trivy"

steps:
  - script: |
      set -euo pipefail

      echo "== OS info =="
      cat /etc/os-release || true

      echo "##[section]Install prerequisites (jq/wget/tar)"
      sudo dnf -y install jq wget tar

      jq --version
      wget --version | head -n 1
      tar --version | head -n 1
    displayName: "Prereqs (CentOS 10): jq + wget + tar"

  - script: |
      set -euo pipefail

      echo "##[section]Installing Trivy (RPM repo)"

      if ! command -v trivy &> /dev/null; then
        # Add Aqua Trivy repo for RHEL/CentOS
        sudo tee /etc/yum.repos.d/trivy.repo >/dev/null <<'EOF'
      [trivy]
      name=Trivy repository
      baseurl=https://aquasecurity.github.io/trivy-repo/rpm/releases/$basearch/
      enabled=1
      gpgcheck=1
      gpgkey=https://aquasecurity.github.io/trivy-repo/rpm/public.key
EOF
        sudo dnf -y makecache
        sudo dnf -y install trivy
      fi

      trivy --version
    displayName: "Install Trivy"

  - script: |
      set -euo pipefail

      echo "##[section]Installing conftest (OPA)"
      if ! command -v conftest >/dev/null 2>&1; then
        CONFTEST_VERSION="0.56.0"
        wget -q "https://github.com/open-policy-agent/conftest/releases/download/v${CONFTEST_VERSION}/conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
        tar -xzf "conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
        sudo install -m 0755 conftest /usr/local/bin/conftest
        rm -f conftest "conftest_${CONFTEST_VERSION}_Linux_x86_64.tar.gz"
      fi
      conftest --version
    displayName: "Install Conftest"

  - script: |
      set -euo pipefail

      echo "##[section]Scanning image (Trivy JSON): ${{ parameters.imageName }}:${{ parameters.imageTag }}"
      mkdir -p "$(Build.ArtifactStagingDirectory)/trivy-reports"

      IGNORE_UNFIXED=""
      if [ "${{ parameters.ignoreUnfixed }}" = "True" ]; then
        IGNORE_UNFIXED="--ignore-unfixed"
      fi

      trivy image \
        --severity "${{ parameters.severityThreshold }}" \
        --format json \
        --output "$(Build.ArtifactStagingDirectory)/trivy-reports/trivy-report.json" \
        $IGNORE_UNFIXED \
        "${{ parameters.imageName }}:${{ parameters.imageTag }}"

      # Table output for logs (non-blocking)
      trivy image \
        --severity "${{ parameters.severityThreshold }}" \
        $IGNORE_UNFIXED \
        "${{ parameters.imageName }}:${{ parameters.imageTag }}" || true

      echo "Report written to: $(Build.ArtifactStagingDirectory)/trivy-reports/trivy-report.json"
      ls -la "$(Build.ArtifactStagingDirectory)/trivy-reports/"
    displayName: "Run Trivy Scan (JSON + Table)"

  - script: |
      set -euo pipefail

      echo "##[section]Prepare Trivy vulnerabilities as policy inputs"

      REPORT="$(Build.ArtifactStagingDirectory)/trivy-reports/trivy-report.json"
      OUTDIR="$(Build.ArtifactStagingDirectory)/trivy-policy-input"
      mkdir -p "$OUTDIR"

      # One JSON per vulnerability (so policy can read input.Severity, input.PublishedDate, etc.)
      jq -c '
        [.Results[]?.Vulnerabilities[]?]
        | to_entries[]
        | .value
      ' "$REPORT" | awk '{print > (ENVIRON["OUTDIR"] "/vuln-" NR ".json")}' OUTDIR="$OUTDIR"

      COUNT=$(ls -1 "$OUTDIR"/*.json 2>/dev/null | wc -l | tr -d " ")
      echo "Prepared $COUNT vulnerability input files in $OUTDIR"

      if [ "$COUNT" -eq 0 ]; then
        echo "No vulnerabilities in report. Policy pass."
        exit 0
      fi

      echo "Sample vuln:"
      head -n 1 "$OUTDIR"/vuln-1.json | jq '.'
    displayName: "Prepare Policy Inputs (1 file per vuln)"

  - script: |
      set -euo pipefail

      echo "##[section]Run Policy (Conftest) with age-based ignore rules"

      POLICY_DIR="${{ parameters.regoPolicyPath }}"
      INPUT_DIR="$(Build.ArtifactStagingDirectory)/trivy-policy-input"

      # Since you now have lib/ + policy files, we expect a directory
      if [ ! -d "$POLICY_DIR" ]; then
        echo "##vso[task.logissue type=error]Rego policy directory not found at: $POLICY_DIR"
        ls -la policies || true
        ls -la "$POLICY_DIR" || true
        exit 1
      fi

      set +e
      conftest test "$INPUT_DIR" -p "$POLICY_DIR" --output json > "$(Build.ArtifactStagingDirectory)/trivy-reports/conftest-result.json"
      RC=$?
      set -e

      cat "$(Build.ArtifactStagingDirectory)/trivy-reports/conftest-result.json" | jq '.'

      if [ "${{ parameters.failOnVulnerabilities }}" = "True" ] && [ $RC -ne 0 ]; then
        echo "##vso[task.logissue type=error]Policy check failed: vulnerabilities older than allowed thresholds exist."
        exit 1
      fi

      echo "Policy check passed (or fail disabled)."
    displayName: "Policy Gate (Conftest)"
    name: PolicyGate
    condition: always()

  - task: PublishPipelineArtifact@1
    displayName: "Publish Trivy Reports"
    inputs:
      targetPath: "$(Build.ArtifactStagingDirectory)/trivy-reports"
      artifact: "trivy-reports"
      publishLocation: "pipeline"
    condition: always()

  - task: PublishPipelineArtifact@1
    displayName: "Publish Policy Inputs"
    inputs:
      targetPath: "$(Build.ArtifactStagingDirectory)/trivy-policy-input"
      artifact: "trivy-policy-input"
      publishLocation: "pipeline"
    condition: always()
