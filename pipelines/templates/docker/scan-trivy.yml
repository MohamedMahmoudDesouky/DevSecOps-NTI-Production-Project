parameters:
  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  - name: severityThreshold
    type: string
    default: "CRITICAL,HIGH"

  - name: failOnVulnerabilities
    type: boolean
    default: true

  - name: ignoreUnfixed
    type: boolean
    default: false

  # Optional: path to a Trivy config or policy directory in repo
  - name: regoPolicyPath
    type: string
    default: ""

steps:
  - script: |
      set -euo pipefail

      # Install trivy if missing
      if ! command -v trivy >/dev/null 2>&1; then
        echo "Trivy not found. Installing..."
        sudo rpm -ivh https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.57.1_Linux-64bit.rpm || true
      fi

      trivy --version
    displayName: "Install/Verify Trivy"

  - script: |
      set -euo pipefail

      IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"
      SEVERITY="${{ parameters.severityThreshold }}"
      FAIL="${{ parameters.failOnVulnerabilities }}"
      IGNORE_UNFIXED="${{ parameters.ignoreUnfixed }}"
      POLICY_PATH="${{ parameters.regoPolicyPath }}"

      echo "Scanning image: $IMAGE"
      echo "Severity threshold: $SEVERITY"
      echo "failOnVulnerabilities: $FAIL"
      echo "ignoreUnfixed: $IGNORE_UNFIXED"
      echo "regoPolicyPath: ${POLICY_PATH:-<none>}"

      # If the image is in ECR, login first (helps Trivy pull)
      if echo "$IMAGE" | grep -q "amazonaws.com/"; then
        : "${AWS_REGION:?AWS_REGION is required}"
        : "${AWS_ACCOUNT_ID:?AWS_ACCOUNT_ID is required}"

        REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
        echo "Logging in to ECR for Trivy pull: $REGISTRY"
        aws ecr get-login-password --region "${AWS_REGION}" \
          | docker login --username AWS --password-stdin "${REGISTRY}"
      fi

      # Build Trivy flags
      FLAGS="--severity ${SEVERITY} --format table"

      if [ "$IGNORE_UNFIXED" = "true" ] || [ "$IGNORE_UNFIXED" = "True" ]; then
        FLAGS="$FLAGS --ignore-unfixed"
      fi

      # If you meant "regoPolicyPath" as Trivy config/policy dir, prefer config if exists
      # (Trivy's native config is trivy.yaml; custom policies are more typical with Conftest/OPA,
      # but we keep this hook to avoid breaking your pipeline.)
      if [ -n "$POLICY_PATH" ] && [ -e "$POLICY_PATH" ]; then
        echo "Policy/config path exists: $POLICY_PATH"
        # If it's a file, treat as config
        if [ -f "$POLICY_PATH" ]; then
          FLAGS="$FLAGS --config $POLICY_PATH"
        fi
      fi

      echo "Running: trivy image $FLAGS $IMAGE"

      if [ "$FAIL" = "true" ] || [ "$FAIL" = "True" ]; then
        trivy image $FLAGS "$IMAGE"
      else
        # don't fail the job even if vulns found
        trivy image $FLAGS "$IMAGE" || true
      fi
    displayName: "Trivy Image Scan"
    env:
      AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
      AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
      AWS_REGION: $(AWS_REGION)
      AWS_ACCOUNT_ID: $(AWS_ACCOUNT_ID)
