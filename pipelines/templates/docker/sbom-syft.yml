parameters:
  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  # space-separated formats, e.g. "spdx-json cyclonedx-json"
  - name: outputFormats
    type: string
    default: "spdx-json cyclonedx-json"

  - name: attachToImage
    type: boolean
    default: false

steps:
  - script: |
      set -euo pipefail

      BIN_DIR="$(Pipeline.Workspace)/bin"
      mkdir -p "$BIN_DIR"
      echo "##vso[task.prependpath]$BIN_DIR"

      if command -v syft >/dev/null 2>&1; then
        echo "Syft already installed: $(command -v syft)"
        syft version
        exit 0
      fi

      echo "Syft not found. Installing to $BIN_DIR (no sudo)..."
      curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
        | sh -s -- -b "$BIN_DIR"

      echo "Syft installed:"
      "$BIN_DIR/syft" version
    displayName: "Install/Verify Syft (no sudo)"

  - script: |
      set -euo pipefail

      BIN_DIR="$(Pipeline.Workspace)/bin"
      echo "Using syft at: $BIN_DIR/syft"

      IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"
      FORMATS="${{ parameters.outputFormats }}"

      echo "Generating SBOM for: $IMAGE"
      echo "Formats: $FORMATS"

      mkdir -p sbom

      for fmt in $FORMATS; do
        OUT="sbom/sbom.${fmt}.json"
        echo "-> $BIN_DIR/syft $IMAGE -o $fmt > $OUT"
        "$BIN_DIR/syft" "$IMAGE" -o "$fmt" > "$OUT"
      done

      ls -lah sbom
    displayName: "Generate SBOM(s) with Syft"

  - task: PublishPipelineArtifact@1
    displayName: "Publish SBOM Artifact"
    inputs:
      targetPath: "sbom"
      artifact: "sbom"
      publishLocation: "pipeline"
