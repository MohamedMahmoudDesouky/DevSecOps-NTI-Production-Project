parameters:
  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  - name: outputFormats
    type: string
    default: "spdx-json cyclonedx-json"

  - name: attachToImage
    type: boolean
    default: false

  - name: artifactName   # ðŸ‘ˆ THIS MUST EXIST
    type: string
    default: "sbom-$(System.StageName)-$(System.JobName)"


steps:
  - script: |
      set -euo pipefail

      BIN_DIR="$(Pipeline.Workspace)/bin"
      mkdir -p "$BIN_DIR"
      echo "##vso[task.prependpath]$BIN_DIR"

      echo "== Syft availability check =="

      if command -v syft >/dev/null 2>&1; then
        echo "Syft already installed: $(command -v syft)"
        syft version || true
      else
        echo "Syft not found. Installing to $BIN_DIR (no sudo)..."
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
          | sh -s -- -b "$BIN_DIR"

        echo "Syft installed:"
        "$BIN_DIR/syft" version
      fi

      echo "== Effective syft path =="
      command -v syft
    displayName: "Install/Verify Syft (no sudo)"

  - script: |
      set -euo pipefail

      IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"
      FORMATS="${{ parameters.outputFormats }}"

      echo "Generating SBOM for: $IMAGE"
      echo "Formats: $FORMATS"

      mkdir -p sbom

      SYFT_BIN="$(command -v syft)"
      echo "Using syft: $SYFT_BIN"
      "$SYFT_BIN" version || true

      for fmt in $FORMATS; do
        OUT="sbom/sbom.${fmt}.json"
        echo "-> $SYFT_BIN $IMAGE -o $fmt > $OUT"
        "$SYFT_BIN" "$IMAGE" -o "$fmt" > "$OUT"
      done

      ls -lah sbom
    displayName: "Generate SBOM(s) with Syft"

  - task: PublishPipelineArtifact@1
    displayName: "Publish SBOM Artifact"
    inputs:
      targetPath: "sbom"
      artifact: "${{ parameters.artifactName }}"
      publishLocation: "pipeline"
