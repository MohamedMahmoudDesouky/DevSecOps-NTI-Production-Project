parameters:
  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  # space-separated formats, e.g. "spdx-json cyclonedx-json"
  - name: outputFormats
    type: string
    default: "spdx-json cyclonedx-json"

  - name: attachToImage
    type: boolean
    default: false

  # Unique by default to avoid "Artifact sbom already exists"
  - name: artifactName
    type: string
    default: "sbom-$(System.StageName)-$(System.JobName)"

steps:
  - script: |
      set -euo pipefail

      BIN_DIR="$(Pipeline.Workspace)/bin"
      mkdir -p "$BIN_DIR"
      SYFT_BIN="$BIN_DIR/syft"

      echo "== Syft availability check =="
      echo "BIN_DIR: $BIN_DIR"

      # Install only if the binary isn't already present/executable
      if [ -x "$SYFT_BIN" ]; then
        echo "Syft already present at: $SYFT_BIN"
        "$SYFT_BIN" version || true
      else
        echo "Syft not found at $SYFT_BIN. Installing (no sudo)..."
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh \
          | sh -s -- -b "$BIN_DIR"

        echo "Syft installed at: $SYFT_BIN"
        ls -lah "$BIN_DIR"
        "$SYFT_BIN" version
      fi

      # Prepend path for future steps (nice-to-have, but we won't depend on it)
      echo "##vso[task.prependpath]$BIN_DIR"

      echo "== Effective syft binary (absolute path) =="
      echo "$SYFT_BIN"
    displayName: "Install/Verify Syft (no sudo)"

  - script: |
      set -euo pipefail

      BIN_DIR="$(Pipeline.Workspace)/bin"
      SYFT_BIN="$BIN_DIR/syft"

      if [ ! -x "$SYFT_BIN" ]; then
        echo "ERROR: syft binary not found or not executable at $SYFT_BIN"
        echo "BIN_DIR contents:"
        ls -lah "$BIN_DIR" || true
        exit 1
      fi

      IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"
      FORMATS="${{ parameters.outputFormats }}"

      echo "Generating SBOM for: $IMAGE"
      echo "Formats: $FORMATS"
      echo "Using syft: $SYFT_BIN"

      mkdir -p sbom

      for fmt in $FORMATS; do
        OUT="sbom/sbom.${fmt}.json"
        echo "-> $SYFT_BIN $IMAGE -o $fmt > $OUT"
        "$SYFT_BIN" "$IMAGE" -o "$fmt" > "$OUT"
      done

      echo "SBOM outputs:"
      ls -lah sbom
    displayName: "Generate SBOM(s) with Syft"

  - task: PublishPipelineArtifact@1
    displayName: "Publish SBOM Artifact"
    inputs:
      targetPath: "sbom"
      artifact: "${{ parameters.artifactName }}"
      publishLocation: "pipeline"
