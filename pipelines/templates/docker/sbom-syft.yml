parameters:
  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  # Formats as a space-separated string:
  # Example: "spdx-json cyclonedx-json"
  - name: outputFormats
    type: string
    default: "spdx-json cyclonedx-json"

  - name: attachToImage
    type: boolean
    default: false

steps:
  - script: |
      set -euo pipefail

      # Install syft if missing
      if ! command -v syft >/dev/null 2>&1; then
        echo "Syft not found. Installing..."
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sudo sh -s -- -b /usr/local/bin
      fi

      syft version
    displayName: "Install/Verify Syft"

  - script: |
      set -euo pipefail

      IMAGE="${{ parameters.imageName }}:${{ parameters.imageTag }}"
      FORMATS="${{ parameters.outputFormats }}"

      echo "Generating SBOM for: $IMAGE"
      echo "Formats: $FORMATS"

      mkdir -p sbom

      for fmt in $FORMATS; do
        OUT="sbom/sbom.${fmt}.json"
        echo "-> syft $IMAGE -o $fmt > $OUT"
        syft "$IMAGE" -o "$fmt" > "$OUT"
      done

      ls -lah sbom
    displayName: "Generate SBOM(s) with Syft"

  - task: PublishPipelineArtifact@1
    displayName: "Publish SBOM Artifact"
    inputs:
      targetPath: "sbom"
      artifact: "sbom"
      publishLocation: "pipeline"

  - script: |
      set -euo pipefail
      if [ "${{ parameters.attachToImage }}" = "true" ] || [ "${{ parameters.attachToImage }}" = "True" ]; then
        echo "attachToImage=true requested, but no registry attachment is implemented in this template."
        echo "If you want attachment, do it in your signing step (cosign attach sbom) or provide registry creds here."
      else
        echo "attachToImage=false (skipping attach)."
      fi
    displayName: "Attach SBOM (optional)"
