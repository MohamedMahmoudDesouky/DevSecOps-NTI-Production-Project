parameters:
  - name: dockerfilePath
    type: string
    default: "Dockerfile"

  - name: buildContext
    type: string
    default: "."

  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  - name: buildArgs
    type: string
    default: ""

  - name: enableCache
    type: boolean
    default: true

  - name: cacheRegistry
    type: string
    default: ""

steps:
  - script: |
      set -euo pipefail

      echo "== OS info =="
      cat /etc/os-release || true

      echo "== Checking required tools (no sudo) =="
      missing=0
      for cmd in docker aws curl jq; do
        if ! command -v "$cmd" >/dev/null 2>&1; then
          echo "MISSING: $cmd"
          missing=1
        else
          echo "OK: $cmd -> $(command -v "$cmd")"
        fi
      done

      if [ "$missing" -ne 0 ]; then
        echo ""
        echo "ERROR: Missing required tools on this self-hosted agent."
        echo "Install them ONCE on the agent host (recommended): docker, awscli, curl, jq."
        exit 1
      fi

      echo ""
      echo "== Versions =="
      docker version || true
      aws --version
      curl --version | head -n 1
      jq --version

      echo ""
      echo "== Docker daemon check =="
      if ! docker info >/dev/null 2>&1; then
        echo "ERROR: Docker daemon not reachable."
        echo "Fix on agent host: start docker + ensure this user is in docker group."
        exit 1
      fi
    displayName: "Prereqs (no sudo): verify docker + aws + curl + jq"
