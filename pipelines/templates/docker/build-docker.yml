parameters:
  - name: dockerfilePath
    type: string
    default: "Dockerfile"

  - name: buildContext
    type: string
    default: "."

  - name: imageName
    type: string

  - name: imageTag
    type: string
    default: "$(Build.BuildNumber)"

  - name: buildArgs
    type: string
    default: ""

  - name: enableCache
    type: boolean
    default: true

  - name: cacheRegistry
    type: string
    default: ""

steps:
  - script: |
      set -e

      echo "Docker version:"
      docker version || true

      echo "Build image: ${{ parameters.imageName }}:${{ parameters.imageTag }}"
      echo "Dockerfile:  ${{ parameters.dockerfilePath }}"
      echo "Context:     ${{ parameters.buildContext }}"

      export DOCKER_BUILDKIT=1

      BUILD_ARGS="${{ parameters.buildArgs }}"

      CACHE_ARGS=""
      if [ "${{ parameters.enableCache }}" = "true" ] || [ "${{ parameters.enableCache }}" = "True" ]; then
        if [ -n "${{ parameters.cacheRegistry }}" ]; then
          CACHE_FROM="${{ parameters.cacheRegistry }}/${{ parameters.imageName }}:cache"
          echo "Cache from: $CACHE_FROM"
          docker pull "$CACHE_FROM" || true
          CACHE_ARGS="--cache-from $CACHE_FROM --build-arg BUILDKIT_INLINE_CACHE=1"
        else
          echo "Cache enabled but cacheRegistry is empty - skipping cache-from"
        fi
      else
        echo "Cache disabled"
      fi

      docker build \
        -f "${{ parameters.dockerfilePath }}" \
        -t "${{ parameters.imageName }}:${{ parameters.imageTag }}" \
        -t "${{ parameters.imageName }}:latest" \
        $BUILD_ARGS \
        $CACHE_ARGS \
        "${{ parameters.buildContext }}"

      echo "Image built successfully."
    displayName: "Build Docker Image (BuildKit)"
