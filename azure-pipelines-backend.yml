# azure-pipelines-backend.yml
trigger:
  branches:
    include: [main, release/*]
  tags:
    include: [v*]
  paths:
    include: [backend/*]

pr:
  branches:
    include: [main]
  paths:
    include: [backend/*]

variables:
  - group: "aws-credentials"

  - name: AWS_REGION
    value: "us-east-2"

  - name: EKS_CLUSTER_NAME
    value: "capstone-project"

  # ECR registry base
  - name: ECR_REGISTRY
    value: "$(AWS_ACCOUNT_ID).dkr.ecr.$(AWS_REGION).amazonaws.com"

  # Repo name in ECR
  - name: IMAGE_NAME
    value: "capstone-project-backend"

  # Tag: commit SHA
  - name: IMAGE_TAG
    value: "$(Build.SourceVersion)"

stages:
  - stage: PRChecks
    displayName: "PR Fast Checks"
    condition: eq(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: LintAndTest
        displayName: "Lint & Test"
        pool:
          name: Default
        steps:
          - template: devops/templates/python-pr-checks.yml

  - stage: BuildAndPush
    displayName: "Build, Push, Scan, SBOM, Sign"
    condition: ne(variables['Build.Reason'], 'PullRequest')
    jobs:
      - job: Build
        displayName: "Docker Build + ECR Push + Security + Sign"
        pool:
          name: Default
        steps:
          # 1) Build docker image locally (BuildKit)
          - template: pipelines/templates/docker/build-docker.yml
            parameters:
              imageName: "$(IMAGE_NAME)"
              imageTag: "$(IMAGE_TAG)"
              dockerfilePath: "backend/Dockerfile"
              buildContext: "backend"
              enableCache: true
              cacheRegistry: "$(ECR_REGISTRY)"
              buildArgs: ""


          # 2) Push image to ECR
          - template: pipelines/templates/docker/push-ecr.yml
            parameters:
              imageName: "$(IMAGE_NAME)"
              imageTag: "$(IMAGE_TAG)"
              ecrRegistry: "$(ECR_REGISTRY)"
              pushLatest: true
              additionalTags: ""
              enableImageScanning: true

                  # 3) SBOM (Syft)
          - template: pipelines/templates/docker/sbom-syft.yml
            parameters:
              imageName: "$(ECR_REGISTRY)/$(IMAGE_NAME)"
              imageTag: "$(IMAGE_TAG)"
              outputFormats: "spdx-json cyclonedx-json"
              attachToImage: true
              artifactName: "sbom-$(Build.BuildId)"


          # 4) Trivy scan
          - template: pipelines/templates/docker/scan-trivy.yml
            parameters:
              imageName: "$(ECR_REGISTRY)/$(IMAGE_NAME)"
              imageTag: "$(IMAGE_TAG)"
              severityThreshold: "CRITICAL,HIGH"
              failOnVulnerabilities: true
              ignoreUnfixed: false
              regoPolicyPath: "policies/trivy"

          # 5) Cosign sign
          - template: pipelines/templates/docker/sign-cosign.yml
            parameters:
              imageName: "$(IMAGE_NAME)"
              imageTag: "$(IMAGE_TAG)"
              ecrRegistry: "$(ECR_REGISTRY)"
              signingMethod: "keyless"
              rekorUrl: "https://rekor.sigstore.dev"

  - stage: DeployDev
    displayName: "Deploy to Dev"
    dependsOn: BuildAndPush
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: "Deploy Backend to Dev"
        pool:
          name: Default
        steps:
          - template: pipelines/templates/k8s/deploy-eks.yml
            parameters:
              environment: "dev"
              namespace: "dev"
              manifestsPath: "k8s/dev-backend"
              clusterName: "$(EKS_CLUSTER_NAME)"

