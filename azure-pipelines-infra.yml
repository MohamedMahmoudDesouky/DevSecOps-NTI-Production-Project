# azure-pipelines-infra.yml
# Full DevSecOps Pipeline for Infrastructure & Governance

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - terraform/*
      - k8s/kyverno/*
      - ansible/*

variables:
  - group: "aws-credentials"
  - name: awsRegion
    value: "us-east-2"
  - name: clusterName
    value: "capstone-project"

stages:
  # ==========================================
  # Stage 1: IaC Security & Provisioning
  # ==========================================
  - stage: Infrastructure
    displayName: "Terraform & IaC Security"
    jobs:
      - job: Terraform_Plan_Apply
        displayName: "SCA, Plan & Apply"
        pool:
          name: Default
        steps:
          - script: |
              mkdir -p ~/bin
              export PATH=$PATH:~/bin
              if ! command -v trivy &> /dev/null; then
                echo "Trivy not found in path, downloading to ~/bin..."
                wget -q https://github.com/aquasecurity/trivy/releases/download/v0.49.1/trivy_0.49.1_Linux-64bit.tar.gz
                tar zxvf trivy_0.49.1_Linux-64bit.tar.gz -C ~/bin/ trivy
                rm trivy_0.49.1_Linux-64bit.tar.gz
              fi
              trivy config terraform/
            displayName: "IaC Security Scan (Trivy)"

          - script: |
              set -x
              # Diagnostic: Exhaustive check of the workspace
              git log -1 --oneline
              df -h
              ls -la modules/logging/
              cat modules/logging/main.tf
              cat backend.tf
              
              # Force cleanup of ALL stale state
              rm -rf .terraform .terraform.lock.hcl
              
              # Initialize with explicit lock removal just in case
              terraform init -input=false -reconfigure -no-color \
                -backend-config="bucket=capstone-tf-state-1770806700" \
                -backend-config="key=final-project/terraform.tfstate" \
                -backend-config="region=$(awsRegion)" 
            displayName: "Terraform Init & Exhaustive Diagnostics"
            workingDirectory: "terraform"
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

          - script: |
              terraform validate -no-color
            displayName: "Terraform Validate"
            workingDirectory: "terraform"

          - script: |
              terraform plan -input=false -out=tfplan -no-color 2>&1
            displayName: "Terraform Plan"
            workingDirectory: "terraform"
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(awsRegion)

          - script: |
              terraform apply -input=false -auto-approve tfplan -no-color
            displayName: "Terraform Apply"
            condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
            workingDirectory: "terraform"
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)

  # ==========================================
  # Stage 2: Governance (Kyverno)
  # ==========================================
  - stage: Governance
    displayName: "Kyverno Policy Enforcement"
    dependsOn: Infrastructure
    jobs:
      - job: Setup_Kyverno
        displayName: "Install Kyverno & Apply Policies"
        pool:
          name: Default
        steps:
          - script: |
              aws eks update-kubeconfig --name $(clusterName) --region $(awsRegion)
            displayName: "Update Kubeconfig"
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(awsRegion)

          - script: |
              helm repo add kyverno https://kyverno.github.io/kyverno/
              helm repo update
              helm upgrade --install kyverno kyverno/kyverno \
                -n kyverno --create-namespace \
                --set admissionController.replicas=1 \
                --set backgroundController.replicas=1 \
                --set cleanupController.replicas=1 \
                --set reportsController.replicas=1 \
                --wait --timeout 15m
              kubectl get pods -n kyverno
            displayName: "Install/Upgrade Kyverno"

          - script: |
              # Apply production-ready policies (non-root, resource limits, image verification)
              kubectl apply -f k8s/kyverno/policies/
            displayName: "Apply Kyverno Cluster Policies"

  # ==========================================
  # Stage 3: Secrets Management (Vault)
  # ==========================================
  - stage: Vault_Setup
    displayName: "Vault Integration"
    dependsOn: Infrastructure
    jobs:
      - job: Vault_Injector
        displayName: "Install Vault Agent Injector"
        pool:
          name: Default
        steps:
          - script: |
              aws eks update-kubeconfig --name $(clusterName) --region $(awsRegion)
            displayName: "Update Kubeconfig"
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(awsRegion)

          - script: |
              helm repo add hashicorp https://helm.releases.hashicorp.com
              helm repo update
              # Assuming Vault Public IP is retrieved from TF output or variable
              VAULT_IP=$(aws ec2 describe-instances --filters "Name=tag:Name,Values=vault-instance" --query "Reservations[].Instances[].PublicIpAddress" --output text)
              helm upgrade --install vault hashicorp/vault \
                --set "injector.externalVaultAddr=http://$VAULT_IP:8200" \
                -n vault --create-namespace
            displayName: "Install Vault Agent Injector"
            env:
              AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
              AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
              AWS_DEFAULT_REGION: $(awsRegion)
